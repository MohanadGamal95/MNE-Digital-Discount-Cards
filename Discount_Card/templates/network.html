{% extends "layout.html" %}

{% block title %}
    Medical Network
{% endblock %}

{% block main %}
    <form method="POST" id="network_search">
        {% csrf_token %}
        <div class="container" id="filter-container">
            <div class="row mt-2">
                <div class="col">
                    <div class="dropdown">
                        <select class="form-select form-select-sm" id="governate" aria-label="Select Governate">
                            <option value="" selected disabled hidden>Governate</option>
                            <!-- {% for row in governate %}
                                <option value="{{ row.governate }}">{{ row.governate }}</option>
                            {% endfor %} -->
                        </select>
                    </div>
                </div>
                <div class="col">
                    <div class="dropdown">
                        <select class="form-select form-select-sm" id="area" aria-label="Select Area">
                            <option value="" selected disabled>Area</option>
                            <!-- {% for row in area %}
                                <option value="{{ row.area }}" data-governate="{{ row.governate }}">{{ row.area }}</option>
                            {% endfor %} -->
                        </select>
                    </div>
                </div>
                <div class="col">
                    <div class="dropdown">
                        <select class="form-select form-select-sm" id="type" aria-label="Select Provider Type">
                            <option value="" selected disabled hidden>Provider Type</option>
                            <!-- {% for row in provider_type %}
                                <option value="{{ row.provider_type }}">{{ row.provider_type }}</option>
                            {% endfor %} -->
                        </select>
                    </div>
                </div>
                <div class="col">
                    <div class="dropdown">
                        <select class="form-select form-select-sm" id="speciality" aria-label="Select Speciality">
                            <option value="" selected disabled hidden>Speciality</option>
                            <!-- {% for row in specialty %}
                                <option value="{{ row.specialty }}">{{ row.specialty }}</option>
                            {% endfor %} -->
                        </select>
                    </div>
                </div>
                <div class="row mt-2 justify-content-center">
                    <div class="col text-center">
                        <button class="btn btn-success btn-sm me-2" type="button" id="filter_button">Filter</button>
                        <button class="btn btn-light btn-sm" type="button" id="clear_filter">Clear</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid mt-4" id="map-container" style="height: calc(100vh - 300px);">
            <div id="map" style="height: 100%;" aria-label="Interactive map for location selection"></div>
        </div>
    </form>
    <script>
        let markers = []; // Array to hold the markers

        // Initialize map
        var map = L.map('map').setView([30.04732179, 31.24499314], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        document.addEventListener('DOMContentLoaded', function() {
            const areaSelect = document.getElementById('area');
            const allAreaOptions = Array.from(document.querySelectorAll('option[data-governate]'));

            document.getElementById('governate').addEventListener('change', function() {
                const selectedGovernate = this.value;

                // Reset area
                areaSelect.innerHTML = '<option value ="" selected disabled hidden>Area</option>';

                // Filter area based on selected governate
                let hasMatch = false;      
                allAreaOptions.forEach(option => {
                    const governateValue = option.getAttribute('data-governate');
                    if (governateValue === selectedGovernate) {
                        areaSelect.appendChild(option.cloneNode(true));
                        hasMatch = true;
                    }
                });
                if (!hasMatch) {
                    areaSelect.innerHTML = '<option value="" selected disabled>No Areas Available</option>';
                }           
                areaSelect.disabled = false;
            });
        });

        // Filter Button function
        document.getElementById('filter_button').addEventListener('click', function() {
            const governate = document.getElementById('governate').value || null;
            const area = document.getElementById('area').value || null;
            const providerType = document.getElementById('type').value || null;
            const specialty = document.getElementById('speciality').value || null;

            const data = {
                governate: governate,
                area: area,
                provider_type: providerType,
                specialty: specialty
            };

            fetch('/filter_markers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(locations => {
                // Clear existing markers from the map
                markers.forEach(marker => map.removeLayer(marker));
                markers = []; // Clear the marker array

                // Add new markers to the map
                locations.forEach(location => {
                    const marker = L.marker([location.latitude, location.longitude]).addTo(map)
                        .bindPopup(`${location.provider_name}<br>${location.address}`);
                    markers.push(marker); // Store the marker if you want to clear them later
                });
            })
            .catch(error => console.error('Error fetching markers', error));
        });

        // Clear Filters button
        document.getElementById('clear_filter').addEventListener('click', function() {
            document.getElementById('network_search').reset();
            markers.forEach(marker => map.removeLayer(marker)); // Clear the markers from the map
            markers = []; // Clear the marker array
        });

    </script>
{% endblock %}
